<!doctype html><html lang=fr-fr dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="L'installation de Matrix sur NixOS avec ses Bridges"><title>Matrix sur NixOS</title><link rel=canonical href=https://nicolasguilloux.eu/articles/matrix/><link rel=stylesheet href=/scss/style.min.6760094bd46d013bb79d4a88a84ba4cad7d0e7f530a7329fa7f7d8e712539c70.css><meta property="og:title" content="Matrix sur NixOS"><meta property="og:description" content="L'installation de Matrix sur NixOS avec ses Bridges"><meta property="og:url" content="https://nicolasguilloux.eu/articles/matrix/"><meta property="og:site_name" content="Nicolas Guilloux"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="matrix"><meta property="article:tag" content="messaging"><meta property="article:tag" content="bridges"><meta property="article:tag" content="nixos"><meta property="article:tag" content="docker"><meta property="article:published_time" content="2021-03-26T00:00:00+00:00"><meta property="article:modified_time" content="2021-03-26T00:00:00+00:00"><meta property="og:image" content="https://nicolasguilloux.eu/articles/matrix/matrix.svg"><meta name=twitter:title content="Matrix sur NixOS"><meta name=twitter:description content="L'installation de Matrix sur NixOS avec ses Bridges"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://nicolasguilloux.eu/articles/matrix/matrix.svg"><link rel="shortcut icon" href=images/favicon.png></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"dark")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Afficher le menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><img src=/images/avatar_hu33d8f2710ea4928d295bd08cdc05f6eb_143407_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></figure><h1 class=site-name><a href=https://nicolasguilloux.eu>Nicolas Guilloux</a></h1><h2 class=site-description>Développeur Backend Symfony</h2></header><ol class=menu id=main-menu><li class=social><a href=mailto:nicolas.guilloux@protonmail.com target=_blank title=Email><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="at" class="svg-inline--fa fa-at fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 8C118.941 8 8 118.919 8 256c0 137.059 110.919 248 248 248 48.154.0 95.342-14.14 135.408-40.223 12.005-7.815 14.625-24.288 5.552-35.372l-10.177-12.433c-7.671-9.371-21.179-11.667-31.373-5.129C325.92 429.757 291.314 440 256 440c-101.458.0-184-82.542-184-184S154.542 72 256 72c100.139.0 184 57.619 184 160 0 38.786-21.093 79.742-58.17 83.693-17.349-.454-16.91-12.857-13.476-30.024l23.433-121.11C394.653 149.75 383.308 136 368.225 136h-44.981a13.518 13.518.0 00-13.432 11.993l-.01.092c-14.697-17.901-40.448-21.775-59.971-21.775-74.58.0-137.831 62.234-137.831 151.46.0 65.303 36.785 105.87 96 105.87 26.984.0 57.369-15.637 74.991-38.333 9.522 34.104 40.613 34.103 70.71 34.103C462.609 379.41 504 307.798 504 232 504 95.653 394.023 8 256 8zm-21.68 304.43c-22.249.0-36.07-15.623-36.07-40.771.0-44.993 30.779-72.729 58.63-72.729 22.292.0 35.601 15.241 35.601 40.77.0 45.061-33.875 72.73-58.161 72.73z"/></svg></a><a href=https://github.com/NicolasGuilloux target=_blank title=Github><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="github" class="svg-inline--fa fa-github fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></a><a href=https://gitlab.com/NicolasGuilloux target=_blank title=Gitlab><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="gitlab" class="svg-inline--fa fa-gitlab fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M105.2 24.9c-3.1-8.9-15.7-8.9-18.9.0L29.8 199.7h132c-.1.0-56.6-174.8-56.6-174.8zM.9 287.7c-2.6 8 .3 16.9 7.1 22l247.9 184-226.2-294zm160.8-88 94.3 294 94.3-294zm349.4 88-28.8-88-226.3 294 247.9-184c6.9-5.1 9.7-14 7.2-22zM425.7 24.9c-3.1-8.9-15.7-8.9-18.9.0l-56.6 174.8h132z"/></svg></a><a href=https://www.malt.fr/profile/nicolasguilloux target=_blank title=Malt><svg xmlns="http://www.w3.org/2000/svg" width="186.795" height="186.795" viewbox="0 0 186.795 186.795" fill="none" id="svg28"><defs id="defs32"/><path d="m159.852 26.953c-14.1-14.1-29.162-4.974-38.588 4.452L32.22 120.452c-9.426 9.425-19.292 23.746-4.452 38.584 14.84 14.843 29.161 4.975 38.585-4.451L155.399 65.54c9.426-9.427 18.552-24.489 4.453-38.587z" fill="currentcolor" id="path2"/><path d="M74.78 23.306 93.635 42.16l19.192-19.192c1.303-1.306 2.626-2.518 3.957-3.661C114.774 9.167 108.988.0 93.626.0 78.235.0 72.456 9.203 70.457 19.365c1.437 1.243 2.871 2.489 4.323 3.941z" fill="currentcolor" id="path4"/><path d="m112.816 163.359-19.18-19.181-18.845 18.843c-1.431 1.432-2.855 2.74-4.273 3.969 2.161 10.337 8.277 19.805 23.11 19.805 14.872.0 20.98-9.519 23.127-19.889-1.319-1.135-2.639-2.248-3.939-3.547z" fill="currentcolor" id="path6"/><path d="M66.783 69.013H30.433C17.105 69.013.0 73.212.0 93.15c0 14.877 9.522 20.986 19.894 23.132 1.228-1.418 46.889-47.269 46.889-47.269z" fill="currentcolor" id="path8"/><path d="m167.435 69.981c-1.15 1.338-46.907 47.305-46.907 47.305h35.834c13.329.0 30.433-3.149 30.433-24.136.0-15.389-9.2-21.171-19.36-23.169z" fill="currentcolor" id="path10"/><path d="M78.693 57.081l6.494-6.494L66.344 31.741C56.917 22.316 42.598 12.449 27.758 27.289 16.876 38.171 19.293 48.762 25.065 57.36 26.823 57.23 78.693 57.081 78.693 57.081z" fill="currentcolor" id="path12"/><path d="m108.571 129.218-6.511 6.511 19.194 19.192c9.426 9.427 24.488 18.551 38.586 4.453 10.52-10.521 8.106-21.571 2.29-30.423-1.872.135-53.559.267-53.559.267z" fill="currentcolor" id="path14"/></svg></a><a href=https://www.linkedin.com/in/nicolas-guilloux/ target=_blank title=LinkedIn><svg aria-hidden="true" focusable="false" data-prefix="fab" data-icon="linkedin" class="svg-inline--fa fa-linkedin fa-w-14" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg></a><a href=https://drive.google.com/file/d/0B1PcOYDQ5VxbX1B6ZVhfZWp0S0E/view target=_blank title=CV><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="id-card" class="svg-inline--fa fa-id-card fa-w-18" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M528 32H48C21.5 32 0 53.5.0 80v16h576V80c0-26.5-21.5-48-48-48zM0 432c0 26.5 21.5 48 48 48h480c26.5.0 48-21.5 48-48V128H0v304zm352-232c0-4.4 3.6-8 8-8h144c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4.0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4.0-8-3.6-8-8v-16zm0 64c0-4.4 3.6-8 8-8h144c4.4.0 8 3.6 8 8v16c0 4.4-3.6 8-8 8H360c-4.4.0-8-3.6-8-8v-16zM176 192c35.3.0 64 28.7 64 64s-28.7 64-64 64-64-28.7-64-64 28.7-64 64-64zM67.1 396.2C75.5 370.5 99.6 352 128 352h8.2c12.3 5.1 25.7 8 39.8 8s27.6-2.9 39.8-8h8.2c28.4.0 52.5 18.5 60.9 44.2 3.2 9.9-5.2 19.8-15.6 19.8H82.7c-10.4.0-18.8-10-15.6-19.8z"/></svg></a><style>#main-menu li.social svg{margin:auto}#main-menu li.social a{margin-left:1em}#main-menu li.social a:first-child{margin-left:0}</style></li><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Accueil</span></a></li><li><a href=/recherche/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Recherche</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/a-propos/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>A propos</span></a></li><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Mode Sombre</span></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/articles/matrix/><img src=/articles/matrix/matrix.svg loading=lazy alt="Featured image of post Matrix sur NixOS"></a></div><div class=article-details><header class=article-category><a href=/categories/tutoriels/ style=background-color:#2a9d8f;color:#fff>Tutoriels</a>
<a href=/categories/notes/ style=background-color:#2a9d8f;color:#fff>Notes</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/articles/matrix/>Matrix sur NixOS</a></h2><h3 class=article-subtitle>L'installation de Matrix sur NixOS avec ses Bridges</h3></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>26 March 2021</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>6 minutes de lecture</time></div></footer></div></header><section class=article-content><div class=paragraph><p>Comme beaucoup de personnes, j’ai beaucoup de messageries qui ont su évoluer (ou pas) dans le temps. Et chacunes de ces messageries apportent ses avantages et ses inconvénients, et la plupart des gens ne veulent pas toutes les avoir. Et j’en fais partie !</p></div><div class=paragraph><p>Aussi, j’ai toujours reluqué <a href=https://matrix.org target=_blank rel=noopener>Matrix</a> de loin. Les seules fois où j’avais abordé ce standard, j’ai été très déçu à cause de la lenteur de celui-ci et aussi le fait que ce soit extrêmement intimidant au niveau sécurité.</p></div><div id=beeper class=paragraph><p><span class="image center"><img src=beeper.png alt=beeper></span></p></div><div class=paragraph><p>Finalement, j’ai décidé de me lancer en entendant parler de <a href=https://www.beeper.com target=_blank rel=noopener>Beeper</a> qui permettait de centraliser plein de protocoles au même endroit. J’ai été déçu de voir que c’était très payant pour une utilisation domestique. Et j’ai remarqué par mon don incroyable de lecture de la seule et unique page disponible que Beeper était une application basée sur Matrix et la notion de bridges. Donc, en théorie, on peut faire la même chose sans payer.</p></div><div class=sect1><h2 id=_quest_ce_que_matrix>Qu’est-ce que Matrix</h2><div class=sectionbody><div class=paragraph><p>Matrix est un standard OpenSource pour construire une messagerie sécurisée en temps réel et décentralisée. Beaucoup de buzz words, on va expliquer tout ça.</p></div><div class=paragraph><p>C’est un <strong>standard</strong>, ce qui veut dire que Matrix n’est pas un logiciel mais simplement une liste de fonctionnalités à implémenter afin de supporter le protocole. C’est un peu comme si on parlait d’un mixeur, qui est la fonctionnalité, ce qui ne l’empêche pas d’avoir un nom donné par la marque ou par les utilisateurs. Le mixeur de mes parents s’appelle Bob.<br>Une <strong>messagerie sécurisée en temps réel</strong>, c’est assez simple à comprendre.<br>Pour le côté <strong>décentralisé</strong>, ça veut dire que un seul et unique serveur n’est pas souverain du réseau. Ainsi, installer un serveur chez vous permettra d’avoir accès au service sur votre réseau. Matrix implémente aussi un système pour faire dialoguer les serveurs entre eux, comme ça votre serveur ne reste pas dans son coin et pourra dialoguer avec le monde extérieur.</p></div><div class=paragraph><p>On a parlé plus haut des bridges, et ça c’est une des fonctionnalités de Matrix. Le principe est qu’on peut ajouter un genre de plugin qui joue le rôle d’interface avec quelque chose d’autre. Ouais c’est un peu abstrait, mais concrètement un bridge peut se charger en temps réel de relayer les messages d’une autre messagerie par exemple.</p></div></div></div><div class=sect1><h2 id=_installation_du_serveur>Installation du serveur</h2><div class=sectionbody><div class=paragraph><p>J’ai rassemblé tous mes efforts pour que tout fonctionne dans un dossier de mon installation NixOS. Il peut varier dans le temps, j’actualiserais le tutoriel et les liens vers ma configuration en fonction des updates.</p></div><div class=sect2><h3 id=_le_serveur_synapse>Le serveur Synapse</h3><div class=paragraph><p><a href=https://gitlab.com/NicolasGuilloux/nixos-configuration/-/blob/master/server/matrix/server.nix target=_blank rel=noopener><span class=image><img src=https://img.shields.io/badge/Gitlab-Synapse-orange alt=Gitlab></span></a></p></div><div class=paragraph><p>Tout commence d’abord par installer <a href=https://matrix.org/docs/projects/server/synapse>Synapse</a> qui est un serveur Matrix. Matrix étant un standard, Synapse est une implémentation de celui-ci. Si vous êtes déjà perdu, relisez le point précédent ;)</p></div><div class=paragraph><p>Ici, NixOS nous a bien facilité la tache vu qu’une configuration est disponible, donc on peut aller très vite.</p></div><div class=listingblock><div class=content><pre class=highlight><code>services.matrix-synapse = {
  enable = true;
  server_name = &#34;matrix.nicolasguilloux.eu&#34;;
  registration_shared_secret = &#34;UnSecretTemporaire&#34;;
  # enable_registration = true;

  listeners = [
    {
      port = 8008;
      bind_address = &#34;::1&#34;;
      type = &#34;http&#34;;
      tls = false;
      x_forwarded = true;
      resources = [
        {
          names = [ &#34;client&#34; &#34;federation&#34; ];
          compress = false;
        }
      ];
    }
  ];
};

# For the registration of a user
services.matrix-synapse.registration_shared_secret = &#34;UnSecretTemporaire&#34;;
environment.systemPackages = [ pkgs.matrix-synapse ];</code></pre></div></div><div class=paragraph><p>Il faut s’assurer que l’option <code>server_name</code> correspond bien à l’adresse finale du serveur. C’est important pour faire dialoguer le monde extérieur avec notre instance. Si jamais vous vous lancez dans l’installation et que cette adresse est fausse, il faudra tout recommencer.</p></div><div class=paragraph><p>Ici, on n’utilise qu’un seul port : le <code>8008</code>. C’est celui conseillé dans la documentation. Vous remarquerez qu’il n’y a pas de SSL, c’est parce que mon serveur sera exposé à travers un Reverse Proxy géré par Nginx. On va voir ça après.</p></div><div class=paragraph><p>L’option <code>registration_shared_secret</code> est là uniquement pour enregistrer votre utilisateur administrateur. Il faudra bien penser à l’enlever, car elle permet de créer des utilisateurs un peu comme on veut en utilisant le dit mot de passe.</p></div><div class=paragraph><p>Et enfin, pas besoin d’importer le paquet de Synapse dans les ceux de système hormis pour l’inscription d’un nouvel utilisateur via un terminal.</p></div></div><div class=sect2><h3 id=_la_base_de_données>La base de données</h3><div class=paragraph><p><a href=https://gitlab.com/NicolasGuilloux/nixos-configuration/-/blob/master/server/matrix/database.nix target=_blank rel=noopener><span class=image><img src=https://img.shields.io/badge/Gitlab-BDD-orange alt=Gitlab></span></a></p></div><div class=paragraph><p>Il faudra aussi configurer une base de données PostgreSQL pour le serveur.</p></div><div class=listingblock><div class=content><pre class=highlight><code># Manually configure PostgreSQL
# ref: https://www.foxypossibilities.com/2018/02/04/running-matrix-synapse-on-nixos/
services.postgresql.enable = true;
services.postgresql.initialScript = pkgs.writeText &#34;synapse-init.sql&#34; &#39;&#39;
  CREATE ROLE &#34;matrix-synapse&#34; WITH LOGIN PASSWORD &#39;${config.secrets.matrix.database}&#39;;
  CREATE DATABASE &#34;matrix-synapse&#34; WITH OWNER &#34;matrix-synapse&#34;
    TEMPLATE template0
    LC_COLLATE = &#34;C&#34;
    LC_CTYPE = &#34;C&#34;;
&#39;&#39;;</code></pre></div></div><div class=paragraph><p>Ici, mon mot de passe est défini bien au chaud dans la config. Pensez à mettre votre mot de passe. Vous pouvez aussi faire cette étape à la mano en allant tater <code>sudo -u postgres psql</code>.</p></div></div><div class=sect2><h3 id=_création_de_notre_admin>Création de notre admin</h3><div class=paragraph><p>Avant d’exposer sur Internet, on va déjà créer notre utilisateur admin puis désactiver la possibilité de s’enregistrer en utilisant les lignes de commandes. Comme ça, on ferme une porte !</p></div><div class=paragraph><p>Ici, rappelez vous la <code>registration_shared_secret</code> mis plus haut et simplement tapez la commande suivante</p></div><div class=quoteblock><blockquote><div class=paragraph><p>register_new_matrix_user --shared-secret "UnSecretTemporaire" <a href=http://localhost:8008 class=bare>http://localhost:8008</a></p></div></blockquote></div><div class=paragraph><p>On suit donc tout ce qu’il nous dit comme il faut en prenant soin de mettre votre utilisateur Admin.</p></div></div><div class=sect2><h3 id=_le_reverse_proxy>Le Reverse Proxy</h3><div class=paragraph><p><a href=https://gitlab.com/NicolasGuilloux/nixos-configuration/-/blob/master/server/matrix/nginx.nix target=_blank rel=noopener><span class=image><img src=https://img.shields.io/badge/Gitlab-Nginx-orange alt=Gitlab></span></a></p></div><div class=paragraph><p>On va maintenant configurer notre Reverse Proxy pour qu’il puisse être accessible du monde extérieur. C’est important aussi pour pouvoir dialoguer avec les autres serveurs.</p></div><div class=listingblock><div class=content><pre class=highlight><code>let
  listenPort = port: ssl: {
    addr = &#34;0.0.0.0&#34;;
    port = port;
    ssl = ssl;
  };
in
{
  # Open port
  networking.firewall.allowedTCPPorts = [ 8448 ];

  # Reverse proxy
  services.nginx.virtualHosts.&#34;matrix.nicolasguilloux.eu&#34; = {
    enableACME = true;
    forceSSL = true;

    listen = [
      (listenPort 80 false)
      (listenPort 443 true)
      (listenPort 8448 true)
    ];

    locations.&#34;/_matrix&#34; = {
      proxyPass = &#34;http://[::1]:8008&#34;;
    };
  };
}</code></pre></div></div><div class=paragraph><p>Ici, on voit que nous redirigeons tout vers notre serveur Synpase. On peut aussi voir qu’on utilise le port 8448. Il est important car c’est ce port qui est utilisé par la fédération des serveurs Matrix. Ainsi, un serveur lambda ira questionner notre serveur via ce port uniquement.</p></div><div class=paragraph><p>Une fois tout installé, vous pouvez d’ailleurs <a href=https://federationtester.matrix.org target=_blank rel=noopener>tester votre serveur</a> pour voir s’il est bien accessible par la fédération.</p></div><div class=paragraph><p>Si vous avez tout bien fait, normalement vous devez pouvoir vous connecter sur <a href=https://app.element.io/#/login>Element.io</a>, modifier le serveur d’accueil (le fameux <code>server_name</code>) et vous connecter.<br>Vous remarquerez alors que votre pseudo est <code>pseudo:server_name</code>. Par exemple, pour ma part, c’est <code>nover:matrix.nicolasguilloux.eu</code>.</p></div></div></div></div><div class=sect1><h2 id=_les_bridges>Les Bridges</h2><div class=sectionbody><div class=paragraph><p>Une fois votre serveur fonctionnel, vous pouvez jouir de toutes les fonctionnalités de Matrix de base. Vous pouvez donc rejoindre des salons et discuter avec des personnes mêmes si elles ne sont pas sur votre serveur grâce à la magie de la fédération.</p></div><div class=paragraph><p>On va maintenant pouvoir ajouter des bridges qui vont être les interfaces entre un autre protocole et celui de Matrix. En plus simple : ça va permettre d’envoyer des messages en utilisant Matrix vers des destinataires comme Signal ou encore Messenger.</p></div><div class=paragraph><p>Ici, je ne vais passer en revue que les bridges que j’ai implémenté sur mon serveur. On notera que la plupart ont été conçu par la même personne et donc ont le préfix <code>mautrix</code>. On peut donc constater qu’ils se configurent quasiment de la même manière.<br>Je vais aussi essayer de trier l’ordre des bridges ci-dessous en fonction de leur difficulté à installer. Ca permettra de monter progressivement en difficulté.</p></div><div class=paragraph><p><a href=../mautrix-facebook><span class=image><img src=https://img.shields.io/badge/mautrix-facebook-blue alt="mautrix facebook blue"></span></a>
<a href=../mautrix-telegram><span class=image><img src=https://img.shields.io/badge/mautrix-telegram-blue alt="mautrix telegram blue"></span></a></p></div></div></div></section><footer class=article-footer><section class=article-tags><a href=/tags/matrix/>matrix</a>
<a href=/tags/messaging/>messaging</a>
<a href=/tags/bridges/>bridges</a>
<a href=/tags/nixos/>nixos</a>
<a href=/tags/docker/>docker</a></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Contenus liés</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/articles/mautrix-signal/><div class=article-image><img src=/articles/mautrix-signal/cover.svg loading=lazy data-key=mautrix-signal data-hash=/articles/mautrix-signal/cover.svg></div><div class=article-details><h2 class=article-title>Le Bridge Signal pour Matrix</h2></div></a></article><article class=has-image><a href=/articles/mautrix-telegram/><div class=article-image><img src=/articles/mautrix-telegram/cover.svg loading=lazy data-key=mautrix-telegram data-hash=/articles/mautrix-telegram/cover.svg></div><div class=article-details><h2 class=article-title>Le Bridge Telegram pour Matrix</h2></div></a></article><article class=has-image><a href=/articles/mautrix-facebook/><div class=article-image><img src=/articles/mautrix-facebook/cover.svg loading=lazy data-key=mautrix-facebook data-hash=/articles/mautrix-facebook/cover.svg></div><div class=article-details><h2 class=article-title>Le Bridge Facebook pour Matrix</h2></div></a></article><article class=has-image><a href=/articles/reverse-proxy-nixos/><div class=article-image><img src=/articles/reverse-proxy-nixos/cover.af64937f9e3e0a258f271e4e3a4c9c86_huecfa39749c24c559ea49b0bcf938d654_423569_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post Reverse Proxy sur NixOS" data-key=reverse-proxy-nixos data-hash="md5-r2STf54+CiWPJx5OOkychg=="></div><div class=article-details><h2 class=article-title>Reverse Proxy sur NixOS</h2></div></a></article></div></div></aside><div id=disqus-container class=disqus-container><h2 id=disqus-title class=article-title>Commentaires</h2><div id=disqus-container-dropdown><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//personalwebsite-6.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><script>document.getElementById("disqus-title").addEventListener("click",e=>{document.getElementById("disqus-container").classList.toggle("extended")})</script><footer class=site-footer><section class=copyright>&copy;
2018 -
2022 Nicolas Guilloux</section><section class=powerby></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>